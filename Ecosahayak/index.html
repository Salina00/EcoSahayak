<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSahayak</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#166534">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <section id="loginSection" class="view-section">
        <div class="login-card">
            <div class="brand-logo">
                <i class="fa-solid fa-leaf"></i> EcoSahayak
            </div>
            <h2>Welcome Back</h2>
            <p>Smart Workforce Management</p>
            
            <input type="text" id="workerId" placeholder="Worker ID (e.g. 101)" class="modern-input">
            <input type="password" id="password" placeholder="Password" class="modern-input">
            
            <button id="loginBtn" class="btn-primary full-width">Login to Dashboard</button>
            <p id="loginError" class="error-text"></p>

            <div class="login-links">
                <span id="showRegister">Register</span> | <span id="showForgot">Forgot Password?</span>
            </div>
        </div>
    </section>

    <section id="registerSection" class="view-section hidden">
        <div class="login-card">
            <h2>New Registration</h2>
            <input type="text" id="regWorkerId" placeholder="Create Worker ID" class="modern-input">
            <input type="password" id="regPassword" placeholder="Create Password" class="modern-input">
            <button id="registerBtn" class="btn-primary full-width">Register Now</button>
            <button id="backToLogin1" class="btn-link">Back to Login</button>
        </div>
    </section>

    <section id="forgotSection" class="view-section hidden">
        <div class="login-card">
            <h2>Reset Password</h2>
            <input type="text" id="forgotWorkerId" placeholder="Enter Worker ID" class="modern-input">
            <input type="password" id="newPassword" placeholder="New Password" class="modern-input">
            <button id="resetBtn" class="btn-primary full-width">Reset Password</button>
            <button id="backToLogin2" class="btn-link">Back to Login</button>
        </div>
    </section>

    <section id="dashboardSection" class="hidden">
        <nav class="top-nav">
            <div class="nav-brand"><i class="fa-solid fa-helmet-safety"></i> EcoSahayak</div>
            <button onclick="location.reload()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card hero-section">
                <div class="status-badge" id="status">üî¥ Inactive</div>
                <h1 id="welcomeText">Good Morning</h1>
                <p>Ready to start your shift?</p>
                <button onclick="handleStartDay()" class="btn-primary full-width large-btn">
                    <i class="fa-solid fa-clock"></i> Start Day
                </button>
            </div>

            <div class="card map-card">
                <h3><i class="fa-solid fa-map-location-dot"></i> Your Location</h3>
                <div id="map"></div>
                <div class="map-info">Site: <span id="siteCoords">Loading...</span></div>
            </div>

            <div class="right-stack">
                <div class="card widget-card">
                    <h3><i class="fa-solid fa-camera"></i> Verification</h3>
                    <div class="camera-box">
                        <video id="videoFeed" autoplay playsinline></video>
                        <canvas id="canvas" style="display:none;"></canvas>
                        <img id="photoPreview" src="" alt="Selfie" style="display:none;">
                    </div>
                    <div class="cam-controls">
                        <button id="openCameraBtn" class="btn-secondary"><i class="fa-solid fa-camera"></i> Open</button>
                        <button id="captureBtn" class="btn-primary hidden"><i class="fa-solid fa-circle-dot"></i> Snap</button>
                        <button id="retakeBtn" class="btn-secondary hidden"><i class="fa-solid fa-rotate-left"></i> Retake</button>
                    </div>
                </div>

                <div class="card widget-card">
                    <div class="card-header">
                        <div class="icon-square" style="background: #fee2e2; color: #dc2626;">
                            <i class="fa-solid fa-calendar-xmark"></i>
                        </div>
                        <h3>Apply for Leave</h3>
                    </div>
                    <div id="leaveForm" style="display:none; margin-top:10px;">
                        <select id="leaveType" class="modern-input">
                            <option value="Sick Leave">Sick Leave ü§í</option>
                            <option value="Casual Leave">Casual Leave üè†</option>
                            <option value="Emergency">Emergency üö®</option>
                        </select>
                        <input type="number" id="leaveDays" placeholder="Days" class="modern-input">
                        <input type="text" id="leaveReason" placeholder="Reason" class="modern-input">
                        <button onclick="submitLeave()" class="btn-primary full-width" style="margin-top:10px; background:#dc2626;">Submit</button>
                    </div>
                    <button id="toggleLeaveBtn" onclick="toggleLeave()" class="btn-link" style="color:#dc2626;">Request Time Off</button>
                </div>

                <div class="card widget-card">
                    <div class="card-header">
                        <h3>Today's Tasks</h3>
                        <span class="percent-text" id="taskPercent">0%</span>
                    </div>
                    <div class="progress-track"><div class="progress-fill" id="progressBar"></div></div>
                    <div class="task-list">
                        <label class="task-item"><input type="checkbox" class="task-check"> <span>Safety Check</span></label>
                        <label class="task-item"><input type="checkbox" class="task-check"> <span>Equipment Log</span></label>
                        <label class="task-item"><input type="checkbox" class="task-check"> <span>Site Cleanup</span></label>
                    </div>
                </div>

                <div class="action-row">
                    <button onclick="triggerSOS()" class="sos-btn"><i class="fa-solid fa-bell"></i> SOS</button>
                    <button onclick="triggerReport()" class="report"><i class="fa-solid fa-triangle-exclamation"></i> Report</button>
                    <button onclick="showCheckout()" class="checkout"><i class="fa-solid fa-right-from-bracket"></i> End Day</button>
                </div>

                <div id="checkoutForm" class="card hidden">
                    <h3>End of Day Report</h3>
                    <textarea id="workReport" placeholder="What did you complete today?" class="modern-input"></textarea>
                    <button onclick="handleEndDay()" class="btn-primary full-width">Submit & Logout</button>
                </div>
            </div>
        </main>
    </section>

    <section id="adminDashboardSection" class="hidden">
        <nav class="top-nav" style="background: #1f2937; color: white;">
            <div class="nav-brand"><i class="fa-solid fa-user-shield"></i> Admin Panel</div>
            <button onclick="location.reload()" class="logout-btn" style="color: white;"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card">
                <h3>üìç Site Geofence</h3>
                <p>Current: <span id="siteCoords" style="font-weight:bold;">Not Set</span></p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="setSiteBtn" class="btn-primary">Set Current Loc</button>
                    <button id="resetSiteBtn" class="btn-secondary">Reset</button>
                </div>
            </div>

            <div class="card">
                <h3>üìä Attendance Stats</h3>
                <div style="height: 200px;">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square" style="background: #fee2e2; color: #dc2626;">
                        <i class="fa-solid fa-triangle-exclamation"></i>
                    </div>
                    <h3>Recent Safety Alerts</h3>
                </div>
                <ul id="reportsList" class="feed-list">
                    <li style="color:#999; text-align:center;">Loading...</li>
                </ul>
                <button onclick="fetchReports()" class="btn-link">Refresh Feed</button>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square" style="background: #e0f2fe; color: #0284c7;">
                        <i class="fa-solid fa-envelope-open-text"></i>
                    </div>
                    <h3>Leave Requests</h3>
                </div>
                <ul id="adminLeaveList" class="feed-list">
                    <li style="color:#999; text-align:center;">Loading...</li>
                </ul>
            </div>
        </main>
    </section>

    <section id="supervisorDashboardSection" class="hidden">
        <nav class="top-nav" style="background: #ea580c; color: white;">
            <div class="nav-brand"><i class="fa-solid fa-helmet-safety"></i> Supervisor Panel</div>
            <button onclick="location.reload()" class="logout-btn" style="color: white;"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card hero-section">
                <div class="card-header">
                    <div class="icon-square" style="background: #ffedd5; color: #ea580c;">
                        <i class="fa-solid fa-users-viewfinder"></i>
                    </div>
                    <h3>Live Muster Roll</h3>
                    <span class="status-pill">Site A</span>
                </div>
                <div class="hero-body">
                    <p style="color:#666; font-size:0.9rem;">Real-time active workers.</p>
                    <ul id="activeWorkerList" style="list-style:none; padding:0; margin-top:15px;">
                        <li style="text-align:center; padding:10px;">‚è≥ Syncing...</li>
                    </ul>
                    <button onclick="fetchActiveWorkers()" class="btn-primary full-width" style="background: #ea580c; margin-top:10px;">
                        <i class="fa-solid fa-rotate"></i> Refresh Status
                    </button>
                </div>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square" style="background: #e0f2fe; color: #0284c7;">
                        <i class="fa-solid fa-calendar-day"></i>
                    </div>
                    <h3>Upcoming Leaves</h3>
                </div>
                <ul id="supLeaveList" class="feed-list">
                    <li style="color:#999; text-align:center;">Loading...</li>
                </ul>
            </div>
        </main>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
    
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ Service Worker Registered'))
                    .catch(err => console.log('‚ùå SW Registration Failed:', err));
            });
        }
    </script>
</body>
</html>