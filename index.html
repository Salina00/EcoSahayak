<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSahayak</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#166534">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <section id="loginSection" class="view-section">
        <div class="login-card">
            <div class="brand-logo"><i class="fa-solid fa-leaf"></i> EcoSahayak</div>
            <h2>Welcome Back</h2>
            <p>Smart Workforce Management</p>

            <input type="text" id="workerId" placeholder="üë§ User ID" class="modern-input">
            <input type="password" id="password" placeholder="üîí Password" class="modern-input">

            <button id="loginBtn" class="btn-primary full-width">
                <i class="fa-solid fa-right-to-bracket"></i> Login
            </button>
            <p id="loginError" class="error-text"></p>

            <div class="login-links">
                <span id="showRegister">üìù Register</span> | <span id="showForgot">‚ùì Forgot Password?</span>
            </div>
        </div>
    </section>

    <section id="dashboardSection" class="hidden">
        <nav class="top-nav">
            <div class="nav-brand"><i class="fa-solid fa-helmet-safety"></i> EcoSahayak</div>
            <div class="emergency-zone">
                <button id="sosBtn" onclick="triggerMilitarySOS()" class="btn-sos">
                    <i class="fa-solid fa-circle-exclamation"></i> SOS
                </button>
            </div>
            <button onclick="handleLogout()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card hero-section">
                <div class="status-badge" id="status">üî¥ Inactive</div>
                <h1 id="welcomeText">Good Morning</h1>
                <p>Ready to start your shift?</p>
                <button onclick="handleStartDay()" class="btn-primary full-width large-btn">
                    <i class="fa-solid fa-clock"></i> Check-In (Start Day)
                </button>
            </div>

            <div class="card map-card">
                <h3><i class="fa-solid fa-map-location-dot"></i> Your Location</h3>
                <div id="map"></div>
                <div class="map-info">üìç GPS Accuracy: <span id="gpsAccuracy">Waiting...</span></div>
                <div class="map-info map-warning">‚ö† You must be inside the Green Circle to check in.</div>
            </div>

            <div class="right-stack">

                <div class="card widget-card">
                    <h3><i class="fa-solid fa-camera"></i> Verification</h3>
                    <div class="camera-box">
                        <video id="videoFeed" autoplay playsinline></video>
                        <canvas id="canvas" style="display:none;"></canvas>
                        <img id="photoPreview" src="" alt="Selfie" style="display:none;">
                    </div>
                    <div class="cam-controls">
                        <button id="openCameraBtn" class="btn-secondary">
                            <i class="fa-solid fa-video"></i> Open
                        </button>
                        <button id="captureBtn" class="btn-primary hidden">
                            <i class="fa-solid fa-camera"></i> Snap
                        </button>
                        <button id="retakeBtn" class="btn-secondary hidden">
                            <i class="fa-solid fa-rotate-left"></i> Retake
                        </button>
                    </div>
                </div>

                <div class="card widget-card">
                    <div class="card-header">
                        <h3><i class="fa-solid fa-clipboard-list"></i> Today's Tasks</h3>
                        <span class="percent-text" id="taskPercent">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                    <div class="task-list" id="workerTaskList">
                        <p style="color:#999; text-align:center; font-size:0.9rem; padding:10px;">
                            ‚úÖ No tasks assigned yet.
                        </p>
                    </div>
                    <button id="submitTasksBtn" onclick="submitFinalTasks()" class="btn-primary"
                        style="margin-top:10px; width:100%;">
                        Submit Daily Progress
                    </button>
                </div>

                <div class="card widget-card activity-card">
                    <div class="card-header">
                        <div class="icon-square green-square">
                            <i class="fa-solid fa-clipboard-check"></i>
                        </div>
                        <h3>Log Field Activity</h3>
                    </div>
                    <div style="margin-top:15px;">
                        <select id="reportCategory" class="modern-input">
                            <option value="Waste Collection">üóë Waste Collection</option>
                            <option value="Tree Plantation">üå± Tree Plantation</option>
                            <option value="Awareness Drive">üì¢ Awareness Drive</option>
                            <option value="Site Issue">‚ö† Site Issue</option>
                        </select>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                            <input type="number" id="reportQty" placeholder="üìä Qty (kg/count)" class="modern-input">
                            <input type="text" id="reportUnit" placeholder="üì¶ Unit (kg, bags)" class="modern-input">
                        </div>
                        <textarea id="reportNotes" placeholder="üìù Details (e.g., Segregated plastic from Zone A)"
                            class="modern-input" rows="2" style="margin-top:10px;"></textarea>
                        <button onclick="submitFieldReport()" class="btn-primary full-width btn-green">
                            <i class="fa-solid fa-paper-plane"></i> Submit Log
                        </button>
                    </div>
                </div>

                <div class="card widget-card leave-card">
                    <h3><i class="fa-solid fa-calendar-xmark"></i> Apply for Leave</h3>
                    <div id="workerLeaveStatus"
                        style="margin-bottom:10px; font-size:0.9rem; padding:8px; border-radius:4px; display:none;">
                    </div>
                    <div id="leaveFormBlock">
                        <select id="leaveType" class="modern-input">
                            <option value="Sick Leave">ü§í Sick Leave</option>
                            <option value="Casual Leave">üè† Casual Leave</option>
                            <option value="Emergency">üö® Emergency</option>
                        </select>
                        <textarea id="leaveReason" placeholder="‚úç Reason (e.g., Fever)" class="modern-input" rows="2"
                            style="margin-top:10px;"></textarea>
                        <button onclick="submitLeave()" class="btn-primary full-width btn-amber">
                            <i class="fa-solid fa-paper-plane"></i> Submit Request
                        </button>
                    </div>
                </div>

                <div class="card widget-card sos-card">
                    <div class="card-header">
                        <div class="icon-square red-square">
                            <i class="fa-solid fa-triangle-exclamation"></i>
                        </div>
                        <h3>Report Issue / SOS</h3>
                    </div>
                    <div style="margin-top:10px;">
                        <select id="issueType" class="modern-input">
                            <option value="Safety Hazard">‚ö† Safety Hazard</option>
                            <option value="Equipment Failure">üõ† Equipment Failure</option>
                            <option value="App Issue">üì± App/Tech Issue</option>
                        </select>
                        <textarea id="issueDesc" placeholder="üìù Describe the problem..." class="modern-input" rows="2"
                            style="margin-top:10px;"></textarea>
                        <button onclick="submitAdminReport()" class="btn-primary full-width btn-red">
                            <i class="fa-solid fa-exclamation-circle"></i> Send to Admin
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </section>

    <section id="supervisorDashboardSection" class="hidden">
        <nav class="top-nav supervisor-nav">
            <div class="nav-brand"><i class="fa-solid fa-users-viewfinder"></i> Supervisor</div>
            <button onclick="handleLogout()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card hero-section supervisor-hero">
                <h3>üë• Live Muster Roll</h3>
                <p style="color:#666; font-size:0.9rem;">Real-time active workers.</p>
                <ul id="activeWorkerList" class="feed-list">
                    <li>‚è≥ Loading...</li>
                </ul>
                <button onclick="fetchActiveWorkers()" class="btn-secondary full-width" style="margin-top:10px;">
                    <i class="fa-solid fa-rotate"></i> Refresh
                </button>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square purple-square">
                        <i class="fa-solid fa-list-check"></i>
                    </div>
                    <h3>Assign Task</h3>
                </div>
                <div style="margin-top:10px;">
                    <input type="text" id="newTaskDesc" placeholder="üìã Task Name (e.g., Clean Zone B)"
                        class="modern-input">
                    <select id="assignWorkerSelect" class="modern-input" style="margin-top:10px;">
                        <option value="">üë§ Select Worker...</option>
                        <option value="101">Worker 101</option>
                        <option value="102">Worker 102</option>
                        <option value="105">Worker 105</option>
                    </select>
                    <button onclick="assignTask()" class="btn-primary full-width btn-purple">
                        <i class="fa-solid fa-plus"></i> Assign Task
                    </button>
                </div>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square green-square">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <h3>Live Field Reports</h3>
                </div>
                <ul id="opsFeedList" class="feed-list" style="margin-top:15px;">
                    <li style="text-align:center; color:#999;">üìä No reports today.</li>
                </ul>
                <button onclick="loadOpsFeed()" class="btn-secondary full-width" style="margin-top:10px;">
                    <i class="fa-solid fa-rotate"></i> Refresh Feed
                </button>
            </div>
            <div class="card">
                <h3><i class="fa-solid fa-list-check"></i> Live Task Completion Feed</h3>
                <ul id="supervisorTaskFeed" class="feed-list">
                    <li style="text-align:center; color:#999; padding:10px;">Loading live updates...</li>
                </ul>
                <button onclick="loadSupervisorTaskMonitoring()" class="btn-secondary"
                    style="width:100%; margin-top:10px;">
                    <i class="fa-solid fa-arrows-rotate"></i> Refresh Task Status
                </button>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square blue-square">
                        <i class="fa-solid fa-envelope-open-text"></i>
                    </div>
                    <h3>Leave Requests</h3>
                </div>
                <ul id="supervisorLeaveList" class="feed-list" style="margin-top:15px;">
                    <li style="text-align:center; color:#999;">üìã No pending requests</li>
                </ul>
            </div>
        </main>
    </section>

    <section id="adminDashboardSection" class="hidden">
        <nav class="top-nav admin-nav">
            <div class="nav-brand"><i class="fa-solid fa-user-shield"></i> Admin Panel</div>
            <button onclick="handleLogout()" class="logout-btn"><i class="fa-solid fa-right-from-bracket"></i></button>
        </nav>

        <main class="main-grid">
            <div class="card admin-geofence-card">
                <h3><i class="fa-solid fa-location-dot"></i> Set Project Geofence</h3>
                <p>üìç Current Site: <span id="adminSiteCoords" style="font-weight:bold;">Not Set</span></p>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button id="setSiteBtn" class="btn-primary">
                        <i class="fa-solid fa-map-pin"></i> Set Current Loc
                    </button>
                    <button id="resetSiteBtn" class="btn-secondary">
                        <i class="fa-solid fa-xmark"></i> Clear
                    </button>
                </div>
            </div>

            <div class="card admin-stats-card">
                <h3><i class="fa-solid fa-chart-column"></i> Global Stats</h3>
                <div style="height: 200px;"><canvas id="attendanceChart"></canvas></div>
            </div>

            <div class="card widget-card">
                <div class="card-header">
                    <div class="icon-square red-square">
                        <i class="fa-solid fa-bell"></i>
                    </div>
                    <h3>Incident Reports</h3>
                </div>
                <ul id="adminReportList" class="feed-list" style="margin-top:15px;">
                    <li style="text-align:center; color:#999;">üîî No active issues.</li>
                </ul>
                <button onclick="loadAdminReports()" class="btn-secondary full-width" style="margin-top:10px;">
                    <i class="fa-solid fa-rotate"></i> Refresh Reports
                </button>
            </div>
        </main>
    </section>

    <section id="registerSection" class="view-section hidden">
        <div class="login-card">
            <div class="brand-logo"><i class="fa-solid fa-user-plus"></i></div>
            <h2>New Registration</h2>
            <input type="text" placeholder="üë§ Create ID" class="modern-input">
            <button class="btn-primary full-width">
                <i class="fa-solid fa-check"></i> Register
            </button>
            <button id="backToLogin1" class="btn-link">
                <i class="fa-solid fa-arrow-left"></i> Back to Login
            </button>
        </div>
    </section>

    <section id="forgotSection" class="view-section hidden">
        <div class="login-card">
            <div class="brand-logo"><i class="fa-solid fa-key"></i></div>
            <h2>Reset Password</h2>
            <input type="email" placeholder="üìß Email Address" class="modern-input">
            <button class="btn-primary full-width">
                <i class="fa-solid fa-paper-plane"></i> Send Reset Link
            </button>
            <button id="backToLogin2" class="btn-link">
                <i class="fa-solid fa-arrow-left"></i> Back to Login
            </button>
        </div>
    </section>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => navigator.serviceWorker.register('sw.js'));
        }
    </script>
</body>

</html>